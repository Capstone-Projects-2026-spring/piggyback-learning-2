<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Expert Preview - Video Question Review</title>
    <link rel="stylesheet" href="/assets/css/expert_preview.css">
</head>
<body data-selected-video-id="{{ (selected_video_id or '') | e }}">
    <div class="container">
        <div class="page-header">
            <h1>Expert Preview - Video Question Review</h1>
            <p>Walk through the downloaded video, refine each AI segment, and prepare the final set of comprehension questions.</p>
        </div>

        <div class="steps" id="expert-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-text">
                    <div class="step-label">Select a Video</div>
                    <div class="step-subtitle">Choose from the downloads folder</div>
                </div>
            </div>
            <div class="step step-disabled" data-step="2">
                <div class="step-number">2</div>
                <div class="step-text">
                    <div class="step-label">Add Questions</div>
                    <div class="step-subtitle">Play, pause, and approve segments</div>
                </div>
            </div>
            <div class="step step-disabled" data-step="3">
                <div class="step-number">3</div>
                <div class="step-text">
                    <div class="step-label">Review Questions</div>
                    <div class="step-subtitle">Check the full question set</div>
                </div>
            </div>
        </div>

        <div id="global-status-messages" class="status-stack"></div>

        <div class="step-content active" id="step-1" data-step="1">
            <div class="selection-card">
                <div class="selection-header">
                    <div class="selection-text">
                        <h2>Select a video to review</h2>
                        <p class="selection-help">Pick a processed video from the downloads folder to preview and refine the AI-generated questions.</p>
                    </div>
                    <button class="btn" id="refresh-videos-btn" onclick="loadVideoList()">Refresh List</button>
                </div>
                <div id="video-card-list" class="video-card-list">
                    <div class="video-list-empty">Loading available videos...</div>
                </div>
            </div>
        </div>

        <div class="step-content" id="step-2" data-step="2">
            <div class="main-grid">
                <div class="video-section">
                    <div class="video-container">
                        <div id="video-container">
                            <div class="video-loading">
                                Select a video to begin
                            </div>
                        </div>
                        <div class="timeline-annotations" id="timeline-annotations" style="display: none;">
                            <!-- Timeline pause points will be added here -->
                        </div>
                        <div class="pause-overlay" id="pause-overlay">
                            <div class="pause-message">
                                <div class="pause-header">
                                    <h3>Capture Expert Question</h3>
                                    <p class="pause-hint">Segment <span id="expert-segment-number">1</span> | <span id="expert-segment-time">00:00 - 00:59</span> | Pause <span id="expert-pause-timestamp">00:00</span></p>
                                    <p class="pause-guidance">Use calm, kid-friendly wording before resuming playback.</p>
                                </div>
                                <form id="expert-question-form" class="pause-form">
                                    <div class="pause-field">
                                        <label for="expert-question-type">Question Type <span style="color: red;">*</span></label>
                                        <select id="expert-question-type" required>
                                            <option value="">Select a question type...</option>
                                            <option value="character">Character</option>
                                            <option value="setting">Setting</option>
                                            <option value="feeling">Feeling</option>
                                            <option value="action">Action</option>
                                            <option value="causal">Causal</option>
                                            <option value="outcome">Outcome</option>
                                            <option value="prediction">Prediction</option>
                                        </select>
                                    </div>
                                    <div class="pause-field">
                                        <label for="expert-question-text">Question <span style="color: red;">*</span></label>
                                        <textarea id="expert-question-text" placeholder="Enter your question (required)" required></textarea>
                                    </div>
                                    <div class="pause-field">
                                        <label for="expert-answer-text">Answer <span style="color: red;">*</span></label>
                                        <textarea id="expert-answer-text" placeholder="Enter the answer (required)" required></textarea>
                                    </div>
                                    <div class="form-feedback" id="expert-form-feedback"></div>
                                    <div class="pause-actions">
                                        <button type="button" class="btn btn-secondary" id="expert-skip-button">Skip Segment</button>
                                        <button type="submit" class="btn btn-success" id="expert-submit-button">Save Question</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="video-controls">
                        <div class="time-display" id="time-display">00:00 / 00:00</div>
                        <div class="control-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="jumpToSegment(-1)">Previous</button>
                            <button class="btn btn-sm" id="play-pause-btn" onclick="togglePlayPause()">Play</button>
                            <button class="btn btn-secondary btn-sm" onclick="jumpToSegment(1)">Next</button>
                            <button class="btn btn-secondary btn-sm" onclick="seekVideo(-10)">-10s</button>
                            <button class="btn btn-secondary btn-sm" onclick="seekVideo(10)">+10s</button>
                            <button class="btn btn-secondary btn-sm" id="use-local-video-btn" type="button">Use downloaded video</button>
                            <button class="btn btn-secondary btn-sm" id="add-manual-question-btn" type="button" disabled>Add Question</button>
                        </div>
                    </div>
                    <div class="questions-panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <h3>Expert Questions</h3>
                                <p class="panel-subtitle">Shape kid-friendly prompts by refining each segment below.</p>
                            </div>
                        </div>
                        <div class="insight-stack">
                            <div class="progress-card">
                                <div class="progress-card-header">
                                    <span class="progress-chip" id="progress-chip">0%</span>
                                    <div class="progress-card-text">
                                        <div class="progress-headline" id="progress-text">Select a video to begin</div>
                                        <div class="progress-subtext" id="progress-subtext">Segment progress will appear here.</div>
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="segment-info" id="segment-info" style="display: none;">
                                <div class="segment-info-header">
                                    <span class="segment-pill" id="segment-index-pill">Segment 1</span>
                                    <div class="segment-info-text">
                                        <span class="segment-label">Active segment</span>
                                        <span class="segment-time" id="segment-time">00:00 - 00:00</span>
                                    </div>
                                </div>
                                <div class="segment-metrics">
                                    <div class="segment-metric">
                                        <span class="metric-label">Length</span>
                                        <span class="metric-value" id="segment-duration">0s</span>
                                    </div>
                                    <div class="segment-metric">
                                        <span class="metric-label">Next pause</span>
                                        <span class="metric-value" id="segment-next-pause">00:00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ai-questions" id="expert-questions">
                            <!-- AI questions will be populated here -->
                        </div>
                        <div class="approve-section" id="approve-section" style="display: none;">
                            <h3>Ready to Approve?</h3>
                            <p>Review the questions above and click approve to continue to the next segment</p>
                            <button class="btn btn-success" onclick="approveAndContinue()">Approve & Continue</button>
                        </div>
                        <div class="review-button-bar">
                            <button class="btn" id="review-button" onclick="handleReviewQuestions()" disabled>Review Questions</button>
                        </div>
                        <div id="status-messages"></div>
                    </div>
                </div>
            </div>
            
            <!-- Manual Add Question Modal -->
            <div class="add-question-modal" id="add-question-modal">
                <div class="add-question-content">
                    <div class="add-question-header">
                        <h3>Add Expert Question</h3>
                        <p>Capture a custom prompt at this moment using age-appropriate, caregiver-friendly language.</p>
                    </div>
                    
                    <form id="manual-question-form">
                        <p class="modal-hint">Tip: keep it short, concrete, and rooted in what children can see or feel.</p>
                        <div class="timestamp-display">
                            <span class="timestamp-label">Timestamp:</span>
                            <input type="text" 
                                   class="timestamp-input" 
                                   id="manual-timestamp" 
                                   placeholder="0:00"
                                   pattern="^(?:(?:([0-9]+):)?([0-5]?[0-9]):)?([0-5]?[0-9])$"
                                   title="Enter time as MM:SS or HH:MM:SS"
                                   required>
                            <span class="timestamp-value" id="manual-timestamp-display" style="display: none;">00:00</span>
                        </div>
                        
                        <div class="pause-field">
                            <label for="manual-question-type">Question Type <span style="color: red;">*</span></label>
                            <select id="manual-question-type" required>
                                <option value="">Select a question type...</option>
                                <option value="character">Character</option>
                                <option value="setting">Setting</option>
                                <option value="feeling">Feeling</option>
                                <option value="action">Action</option>
                                <option value="causal">Causal</option>
                                <option value="outcome">Outcome</option>
                                <option value="prediction">Prediction</option>
                            </select>
                        </div>
                        
                        <div class="pause-field">
                            <label for="manual-question-text">Question <span style="color: red;">*</span></label>
                            <textarea id="manual-question-text" placeholder="Enter your question (required)" required></textarea>
                        </div>
                        
                        <div class="pause-field">
                            <label for="manual-answer-text">Answer <span style="color: red;">*</span></label>
                            <textarea id="manual-answer-text" placeholder="Enter the answer (required)" required></textarea>
                        </div>
                        
                        <div class="form-feedback" id="manual-form-feedback"></div>
                        
                        <div class="pause-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeAddQuestionModal()">Cancel</button>
                            <button type="submit" class="btn btn-success">Save Question</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- LLM Review Modal -->
        <div class="llm-review-modal" id="llm-review-modal">
            <div class="llm-review-content">
                <div class="llm-review-header">
                    <h3 id="llm-modal-step-title">Review AI Questions</h3>
                    <p id="llm-modal-segment-label">Segment details</p>
                </div>
                <div class="llm-modal-feedback" id="llm-modal-feedback"></div>
                <div class="llm-step-content active" id="llm-step-1">
                    <p class="llm-step-instructions"><span class="llm-instruction-icon" aria-hidden="true">i</span><span class="llm-instruction-text"><strong><em>Review the AI generated questions, mark the inappropriate ones by clicking on the trash icon, and optionally leave a note.</em></strong></span></p>
                    <div class="llm-step-stack">
                        <div class="llm-section-box">
                            <h4 class="llm-section-title">Questions</h4>
                            <p class="llm-section-help">Review each question. Use the trash button to remove anything that should not be ranked.</p>
                            <ul class="llm-triage-list" id="llm-triage-list"></ul>
                            <div class="llm-triage-empty" id="llm-triage-empty">No questions available.</div>
                        </div>
                        <div class="llm-section-box llm-trashed-section">
                            <h4 class="llm-section-title">Trashed Questions</h4>
                            <p class="llm-section-help">Trashed questions move to the bottom. Restore one if you change your mind.</p>
                            <ul class="llm-triage-trash-list" id="llm-triage-trash-list"></ul>
                            <div class="llm-triage-trash-empty" id="llm-triage-trash-empty">No questions in trash.</div>
                        </div>
                    </div>
                    <div class="llm-comment-section">
                        <label for="llm-triage-comment">Comment (optional)</label>
                        <textarea id="llm-triage-comment" placeholder="Add an optional note about removed questions."></textarea>
                    </div>
                    <div class="llm-step-footer">
                        <button type="button" class="btn btn-success" id="llm-step-next-btn">Next: Rank Questions</button>
                    </div>
                </div>
                <div class="llm-step-content" id="llm-step-2">
                    <p class="llm-step-instructions"><span class="llm-instruction-icon" aria-hidden="true">i</span><span class="llm-instruction-text"><strong><em>Rank the remaining comprehension questions, and leave an optional note to explain your logic.</em></strong></span></p>
                    <div class="llm-step-stack">
                        <div class="llm-section-box">
                            <h4 class="llm-section-title">Ranking</h4>
                            <p class="llm-section-help">Drag questions to reorder them. The rank badge shows the current position.</p>
                            <ul class="llm-ranking-list" id="llm-ranking-list"></ul>
                            <div class="llm-ranking-empty" id="llm-ranking-empty">No questions available to rank.</div>
                        </div>
                        <div class="llm-section-box llm-inline-trash" id="llm-trash-dropzone">
                            <h4 class="llm-section-title">Inappropriate Questions</h4>
                            <p class="llm-section-help">Drop a question here to remove it from the ranked list. Drag it back above to restore.</p>
                            <ul class="llm-trash-list" id="llm-ranking-trash-list"></ul>
                            <div class="llm-trash-empty" id="llm-ranking-trash-empty">No questions in trash.</div>
                        </div>
                    </div>
                    <div class="llm-comment-section">
                        <label for="llm-ranking-comment">Comment (optional)</label>
                        <textarea id="llm-ranking-comment" placeholder="Add an optional note about your ranking decisions."></textarea>
                    </div>
                    <div class="llm-step-footer">
                        <button type="button" class="btn btn-secondary" id="llm-step-back-btn">Back</button>
                        <button type="button" class="btn btn-success" id="llm-review-submit-btn">Submit &amp; Continue</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="step-content" id="step-3" data-step="3">
            <div class="review-card">
                <h2>Review Questions</h2>
                <p class="selection-help">Inspect each segment and its questions before sharing them with learners.</p>
                <div class="review-meta">
                    <div><strong>Video:</strong> <span id="review-video-id">Not selected</span></div>
                    <div><strong>Total segments:</strong> <span id="review-total-segments">0</span></div>
                </div>
                <div class="review-questions-list" id="review-questions-list">
                    <div class="review-placeholder">Select a video on Step 1 and choose 'Review Questions' to view the full set.</div>
                </div>
            </div>
        </div>

    </div>
<script src="/assets/js/expert_preview.js" defer></script>
</body>
</html>


